<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="issue-508" author="brunneng"> <!-- ИД-строка кода классификатора КОАТУУ -->
        <addColumn tableName="Region">
            <column name="sID_UA" type="varchar(30)">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <addColumn tableName="City">
            <column name="sID_UA" type="varchar(30)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <!-- ####################################################################################################### -->

    <changeSet id="issue-493" author="LamronNu" failOnError="false" runOnChange="true">
        <!--drop table if exists-->
        <sql splitStatements="true" dbms="postgresql">
            DROP SEQUENCE IF EXISTS "HistoryEvent_Service";
        </sql>
        <sql splitStatements="true" dbms="h2">
            DROP SEQUENCE IF EXISTS "HistoryEvent_Service";
        </sql>
        <!--create table-->
        <createTable tableName="HistoryEvent_Service">
            <column name="nID" type="bigint">
                <constraints primaryKey="true" nullable="false" unique="true"/>
            </column>
            <column name="sID" type="varchar(10)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="nID_Task" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="nID_Subject" type="bigint">
                <constraints nullable="true"/>
            </column>
            <column name="sStatus" type="varchar">
                <constraints nullable="false"/>
            </column>
            <column name="sID_Status" type="varchar">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <!--id trigger-->
        <addAutoIncrement
                tableName="HistoryEvent_Service" columnName="nID" startWith="1000" columnDataType="bigint"/>

    </changeSet>

    <changeSet id="issue-493_sID-size" author="LamronNu">
        <modifyDataType tableName="HistoryEvent_Service" columnName="sID" newDataType="varchar(30)" />
    </changeSet>


    <!-- ####################################################################################################### -->

    <changeSet id="issue-487" author="dgroup">

        <createTable tableName="SubjectOrganJoin">
            <column name="nID" type="bigint">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="nID_SubjectOrgan" type="bigint">
                <constraints nullable               ="false"
                             foreignKeyName         ="FK_SubjectOrganJoin_SubjectOrgan"
                             referencedTableName    ="SubjectOrgan"
                             referencedColumnNames  ="nID"
                             deleteCascade          ="true"/>
            </column>
            <column name="sNameUa" type="varchar(200)">
                <constraints nullable="false"/>
            </column>
            <column name="sNameRu" type="varchar(200)">
                <constraints nullable="false"/>
            </column>
            <column name="sID_Privat" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="sID_Public" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="sGeoLongitude" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="sGeoLatitude" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="nID_Region" type="bigint">
                <constraints nullable               ="true"
                             foreignKeyName         ="FK_SubjectOrganJoin_Region"
                             referencedTableName    ="Region"
                             referencedColumnNames  ="nID"
                             deleteCascade          ="true"/>
            </column>
            <column name="nID_City" type="bigint">
                <constraints nullable               ="true"
                             foreignKeyName         ="FK_SubjectOrganJoin_City"
                             referencedTableName    ="City"
                             referencedColumnNames  ="nID"
                             deleteCascade          ="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="issue-487-PK" author="dgroup">
        <addAutoIncrement tableName="SubjectOrganJoin" columnName="nID" startWith="1000" columnDataType="bigint"/>
    </changeSet>

    <changeSet id="issue-487-add-field-sID_UA" author="dgroup"> <!-- ИД-строка кода классификатора КОАТУУ -->
        <addColumn tableName="SubjectOrganJoin">
            <column name="sID_UA" type="varchar(30)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>
    <!-- ####################################################################################################### -->

    <changeSet id="issue-493_sID-make-optional" author="LamronNu">
        <dropNotNullConstraint tableName="HistoryEvent_Service" columnName="sID" columnDataType="varchar(30)"/>
        <!--<dropUniqueConstraint tableName="HistoryEvent_Service" constraintName="sID" uniqueColumns="sID"/>-->
    </changeSet>

    <changeSet id="issue-493_add-nID_Protected" author="LamronNu">
        <sql splitStatements="true" dbms="postgresql">
            SET CONSTRAINTS ALL DEFERRED;
            DELETE FROM "HistoryEvent_Service";
        </sql>
        <addColumn tableName="HistoryEvent_Service">
            <column name="nID_Protected" type="bigint" >
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <!-- ####################################################################################################### -->
    <changeSet id="issue-493_changeFields" author="LamronNu">
        <dropColumn tableName="HistoryEvent_Service" columnName="nID_Protected" />
        <dropColumn tableName="HistoryEvent_Service" columnName="sID" />
        <addColumn tableName="HistoryEvent_Service">
            <column name="sID" type="varchar(30)">
                <constraints nullable="true" unique="false"/>
            </column>
        </addColumn>
        <!--<dropUniqueConstraint tableName="HistoryEvent_Service" constraintName="sID" uniqueColumns="sID"/>-->
    </changeSet>

    <changeSet id="issue-511" author="brunneng">
        <createTable tableName="Merchant">
            <column name="nID" type="int">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="sID" type="varchar(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="sName" type="varchar(200)">
                <constraints nullable="true"/>
            </column>
            <column name="sURL_CallbackStatusNew" type="varchar(500)">
                <constraints nullable="true"/>
            </column>
            <column name="sURL_CallbackPaySuccess" type="varchar(500)">
                <constraints nullable="true"/>
            </column>
            <column name="nID_SubjectOrgan" type="int">
                <constraints nullable="true"
                             foreignKeyName="FK_Merchant_SubjectOrgan"
                             referencedTableName="SubjectOrgan" referencedColumnNames="nID" deleteCascade="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="issue-511-autoIncrement" author="brunneng" dbms="h2">
        <addAutoIncrement tableName="Merchant" columnName="nID" startWith="1000" columnDataType="bigint"/>
    </changeSet>

    <changeSet id="issue-528" author="brunneng">
        <createTable tableName="SubjectMessageType">
            <column name="nID" type="int">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="sName" type="varchar(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="sDescription" type="varchar(500)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <insert tableName="SubjectMessageType">
            <column name="nID" value="0"/>
            <column name="sName" value="dummy"/>
            <column name="sDescription" value="dummy"/>
        </insert>

        <addColumn tableName="SubjectMessage">
            <column name="nID_SubjectMessageType" type="int" defaultValue="0">
                <constraints nullable="false"
                             foreignKeyName="FK_SubjectMessage_SubjectMessageType"
                             referencedTableName="SubjectMessageType" referencedColumnNames="nID" deleteCascade="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="issue-528-autoIncrement" author="brunneng" dbms="h2">
        <addAutoIncrement tableName="SubjectMessageType" columnName="nID" startWith="1000" columnDataType="bigint"/>
    </changeSet>

    <changeSet id="issue-511_sPrivateKey" author="brunneng">
        <addColumn tableName="Merchant">
            <column name="sPrivateKey" type="varchar(100)" defaultValue="dummy">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    
    <!-- ####################################################################################################### -->

    <changeSet id="issue-515-create_table" author="LamronNu">
        <!--create table-->
        <createTable tableName="Country">
            <column name="nID" type="bigint">
                <constraints primaryKey="true" nullable="false" unique="true"/>
            </column>
            <column name="nID_UA" type="bigint">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="sID_Two" type="varchar(2)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="sID_Three" type="varchar(3)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="sNameShort_UA" type="varchar(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="sNameShort_EN" type="varchar(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="sReference_LocalISO" type="varchar(100)"/>
        </createTable>
    </changeSet>
    <changeSet id="issue-515-autoIncrement" author="LamronNu">
        <addAutoIncrement
                tableName="Country" columnName="nID" startWith="100" columnDataType="bigint"/>
    </changeSet>
    
    <!-- ####################################################################################################### -->

    <changeSet id="issues/553" author="bw" runOnChange="true">
        <dropNotNullConstraint tableName="DocumentAccess" columnName="sTarget" columnDataType="varchar(250)"/>
        <dropNotNullConstraint tableName="DocumentAccess" columnName="sTelephone" columnDataType="varchar(50)"/>
        <dropNotNullConstraint tableName="DocumentAccess" columnName="sMail" columnDataType="varchar(200)"/>
    </changeSet>

    <changeSet id="issues/553_1" author="bw" dbms="postgresql" runOnChange="true">
        <delete tableName="DocumentType">
            <where>"nID" IN (4,5,20324)</where>
        </delete>
    </changeSet>
    <!-- ####################################################################################################### -->

    <changeSet id="issue-556" author="LamronNu">
        <addColumn tableName="DocumentType">
            <column name="bHidden" type="boolean" defaultValue="false" />
        </addColumn>
    </changeSet>

    <!-- ####################################################################################################### -->

    <changeSet id="issue-587" author="LamronNu">
        <addColumn tableName="Document">
            <column name="oSignData" type="varchar" defaultValue="{}">
                <constraints nullable="false"/>
            </column>

        </addColumn>
    </changeSet>

    <!-- ####################################################################################################### -->

    <changeSet id="issue-573" author="dgroup">
        <!-- -->
        <createTable tableName="PlaceType">
            <column name="nID" type="bigint">
                <constraints primaryKey="true"/>
            </column>
            <column name="sName"  type="varchar(30)"/>
            <column name="nOrder" type="number"/>
            <column name="bArea"  type="boolean"/>
            <column name="bRoot"  type="boolean"/>
        </createTable>
        <addAutoIncrement tableName     = "PlaceType"
                          columnName    = "nID"
                          startWith     = "100"
                          columnDataType= "bigint"/>
        <!-- -->
        <createTable tableName="Place">
            <column name="nID" type="bigint">
                <constraints primaryKey="true"/>
            </column>
            <column name="sName" type="varchar(30)"/>
            <column name="nID_PlaceType" type="bigint">
                <constraints nullable               = "false"
                             foreignKeyName         = "FK_Place_PlaceType"
                             referencedTableName    = "PlaceType"
                             referencedColumnNames  = "nID"
                             deleteCascade          = "true"/>
            </column>
            <column name="sID_UA"        type="varchar(100)"/>
            <column name="sNameOriginal" type="varchar(200)"/>
        </createTable>
        <addAutoIncrement tableName     = "Place"
                          columnName    = "nID"
                          startWith     = "100"
                          columnDataType= "bigint"/>
        <!-- -->
        <createTable tableName="PlaceTree">
            <column name="nID" type="bigint">
                <constraints primaryKey="true"/>
            </column>
            <column name="nID_Place" type="bigint">
                <constraints nullable               = "false"
                             foreignKeyName         = "FK_PlaceTree_Place"
                             referencedTableName    = "Place"
                             referencedColumnNames  = "nID"
                             deleteCascade          = "true"/>
            </column>
            <column name="nID_Place_Root"   type="number"/>
            <column name="nID_Place_Area"   type="number"/>
            <column name="nID_Place_Parent" type="number"/>
        </createTable>
        <addAutoIncrement tableName     = "PlaceTree"
                          columnName    = "nID"
                          startWith     = "100"
                          columnDataType= "bigint"/>
    </changeSet>


    <changeSet id="issue-573_fix" author="dgroup_and_bw">
        <modifyDataType tableName="Place" columnName="sName" newDataType="varchar(200)" />
    </changeSet>
    
    <changeSet id="issue-607" author="olga">
        <addColumn tableName="HistoryEvent_Service">
            <column name="sDate" type="timestamp">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>
    
    <changeSet id="issue-605" author="askosyr"> 
	
		<addColumn tableName="FlowProperty">
           <column name="bExclude" type="boolean">
               <constraints nullable="true"/>
           </column>
        </addColumn>
        
		<addColumn tableName="FlowProperty">        
            <column name="sName" type="varchar(100)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        
        <addColumn tableName="FlowProperty">
            <column name="sRegionTime" type="varchar(20)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        
        <addColumn tableName="FlowProperty">
            <column name="saRegionWeekDay" type="varchar(20)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
       
       
       <addColumn tableName="FlowProperty">
            <column name="sDateTimeAt" type="varchar(20)">
                <constraints nullable="true"/>
            </column>
       </addColumn>
       
       <addColumn tableName="FlowProperty">
            <column name="sDateTimeTo" type="varchar(20)">
                <constraints nullable="true"/>
            </column>
       </addColumn>
       
       <dropNotNullConstraint 
            columnDataType="varchar(100)"
            columnName="sData"
            tableName="FlowProperty"/>
	
    </changeSet>
    
    <changeSet id="issue-605-dates-size" author="askosyr">
        <modifyDataType tableName="FlowProperty" columnName="sDateTimeAt" newDataType="varchar(30)" />
        <modifyDataType tableName="FlowProperty" columnName="sDateTimeTo" newDataType="varchar(30)" />
    </changeSet>

    <!-- ####################################################################################################### -->

    <changeSet id="issue-658" author="LamronNu">
        <!--EscalationRuleFunction-->
        <createTable tableName="EscalationRuleFunction">
            <column name="nID" type="bigint">
                <constraints primaryKey="true" nullable="false" unique="true"/>
            </column>
            <column name="sName" type="varchar">
                <constraints nullable="false" />
            </column>
            <column name="sBeanHandler" type="varchar"/>
        </createTable>
        <addAutoIncrement
                tableName="EscalationRuleFunction" columnName="nID"
                startWith="100" columnDataType="bigint"/>

        <!--EscalationRule-->
        <createTable tableName="EscalationRule">
            <column name="nID" type="bigint">
                <constraints primaryKey="true" nullable="false" unique="true"/>
            </column>
            <column name="sID_BP" type="varchar">
                <constraints unique="true" />
            </column>
            <column name="sCondition" type="varchar(200)"/>
            <column name="soData" type="varchar(500)"/>
            <column name="sPatternFile" type="varchar"/>
            <column name="nID_EscalationRuleFunction" type="bigint">
                <constraints foreignKeyName         = "FK_EscalationRule_EscalationRuleFunction"
                             referencedTableName    = "EscalationRuleFunction"
                             referencedColumnNames  = "nID"/>
            </column>

        </createTable>
        <addAutoIncrement
                tableName="EscalationRule" columnName="nID"
                startWith="100" columnDataType="bigint"/>
    </changeSet>

    <changeSet id="issue-658_add-column" author="LamronNu">
        <addColumn tableName="EscalationRule">
            <column name="sID_UserTask" type="varchar">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="issue-658_remove-unique-index" author="LamronNu">
        <dropColumn columnName="sID_BP" tableName="EscalationRule"/>
        <addColumn tableName="EscalationRule">
            <column name="sID_BP" type="varchar"/>
        </addColumn>
    </changeSet>


    <changeSet id="no-issue" author="bw"> 
	
        <addColumn tableName="FlowProperty">
           <column name="nLen" type="bigint">
               <constraints nullable="true"/>
           </column>
        </addColumn>
        
        <addColumn tableName="FlowProperty">        
            <column name="sLenType" type="varchar(100)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
	
    </changeSet>    
    
    <changeSet id="684" author="askosyr"> 
	
        <addColumn tableName="HistoryEvent_Service">
           <column name="nID_Service" type="bigint">
               <constraints nullable="true"/>
           </column>
        </addColumn>
        
        <addColumn tableName="HistoryEvent_Service">
           <column name="nID_Region" type="bigint">
               <constraints nullable="true"/>
           </column>
        </addColumn>
        
        <addColumn tableName="HistoryEvent_Service">        
            <column name="sID_UA" type="varchar(100)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
	
    </changeSet>   
    
    
    <changeSet id="ServiceData_sNote_3000" author="bw"> 
        <modifyDataType tableName="ServiceData" columnName="sNote" newDataType="varchar(3000)" />
    </changeSet>

    <!-- ####################################################################################################### -->

    <changeSet id="issue-777" author="LamronNu">
        <addColumn tableName="HistoryEvent_Service">
            <column name="nRate" type="int">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <!-- ####################################################################################################### -->

    <changeSet id="issue-807" author="LamronNu">
        <addColumn tableName="HistoryEvent_Service">
            <column name="soData" type="varchar">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addColumn tableName="HistoryEvent_Service">
            <column name="sToken" type="varchar">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addColumn tableName="HistoryEvent_Service">
            <column name="sHead" type="varchar">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addColumn tableName="HistoryEvent_Service">
            <column name="sBody" type="varchar">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <!-- ####################################################################################################### -->

    <changeSet id="issue-573_Link_ServiceData_and_Place" author="dgroup">
        <addColumn tableName="ServiceData">
            <column name="nID_Place" type="bigint">
                <constraints foreignKeyName         = "FK_ServiceData_Place"
                             referencedTableName    = "Place"
                             referencedColumnNames  = "nID"
                             deleteCascade          = "true" />
            </column>
        </addColumn>
    </changeSet>
    
    <changeSet id="issue-871" author="askosyr">
        <addColumn tableName="HistoryEvent_Service">
            <column name="nTimeHours" type="int">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="issue-889" author="LamronNu">
        <addColumn tableName="HistoryEvent_Service">
            <column name="sID_Order" type="varchar">
                <constraints nullable="true"/>
            </column>
        </addColumn>
        <addColumn tableName="HistoryEvent_Service">
            <column name="nID_Server" type="int">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="889-addNotNullConstraint" author="LamronNu">
        <addNotNullConstraint columnDataType="int"
                              columnName="nID_Server"
                              defaultNullValue="0"
                              tableName="HistoryEvent_Service"/>
    </changeSet>

    <!-- ####################################################################################################### -->

    <changeSet id="issue-923_Server-entity" author="bw">
        <addColumn tableName="ServiceData">
            <column name="nID_Server" type="int">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="issue-923-fixData" author="brunneng" dbms="postgresql">
        <sql>
            UPDATE "ServiceData" SET "nID_Server"=0 WHERE "nID_Server"=2;
        </sql>
    </changeSet>

    <changeSet id="issue-923-create-Server" author="brunneng">
        <createTable tableName="Server">
            <column name="nID" type="bigint">
                <constraints primaryKey="true" nullable="false" unique="true"/>
            </column>
            <column name="sID" type="varchar(20)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="sType" type="varchar(20)">
            </column>
            <column name="sURL_Alpha" type="varchar(300)">
                <constraints nullable="true"/>
            </column>
            <column name="sURL_Beta" type="varchar(300)">
                <constraints nullable="true"/>
            </column>
            <column name="sURL_Omega" type="varchar(300)">
                <constraints nullable="true"/>
            </column>
            <column name="sURL" type="varchar(300)">
                <constraints nullable="true"/>
            </column>

        </createTable>

        <loadUpdateData primaryKey="nID" encoding="UTF-8" file="data/Server.csv" tableName="Server" separator=";">
            <column name="nID"          type="NUMERIC"/>
            <column name="sID"          type="STRING"/>
            <column name="sType"        type="STRING"/>
            <column name="sURL_Alpha"   type="STRING"/>
            <column name="sURL_Beta"    type="STRING"/>
            <column name="sURL_Omega"   type="STRING"/>
            <column name="sURL"         type="STRING"/>
        </loadUpdateData>


        <addForeignKeyConstraint constraintName="fk_ServiceData_Server"
                                 baseTableName="ServiceData" baseColumnNames="nID_Server"
                                 referencedTableName="Server" referencedColumnNames="nID"
                                 onDelete="CASCADE"/>


    </changeSet>

    <changeSet id="issue-923-autoIncrement" author="brunneng" dbms="h2">
        <addAutoIncrement tableName="Server" columnName="nID" startWith="1000" columnDataType="bigint"/>
    </changeSet>

</databaseChangeLog>